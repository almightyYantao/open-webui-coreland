stages:
  - build-push

variables:
  IMAGE_NAME: "registry.qunhequnhe.com/itsystem/open-webui"
  REGISTRY: "registry.qunhequnhe.com"
  BUILDKIT_HOST: tcp://buildkitd.buildkit-prod.svc.cluster.local:1234
  PROXY_URL: "socks5://10.10.52.137:1088"
  PLATFORMS: "linux/amd64,linux/arm64"

before_script:
  # 登录私有仓库
  - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $REGISTRY

build-push:
  stage: build-push
  image: docker.1ms.run/library/docker:24-cli
  tags:
    - kube-runner
  variables:
    DOCKER_BUILDKIT: 1
    BUILDKIT_HOST: tcp://buildkitd.buildkit-prod.svc.cluster.local:1234
  script:
    # 创建并使用buildx构建器
    - docker buildx create --use --name multiarch --driver remote $BUILDKIT_HOST
    
    # 多平台构建并推送
    - docker buildx build \
        --platform $PLATFORMS \
        --build-arg HTTP_PROXY=$PROXY_URL \
        --build-arg HTTPS_PROXY=$PROXY_URL \
        --build-arg ALL_PROXY=$PROXY_URL \
        --network host \
        --tag $IMAGE_NAME:$CI_COMMIT_SHA \
        --tag $IMAGE_NAME:latest \
        --push .
  only:
    - main
    - develop