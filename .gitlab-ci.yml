# .gitlab-ci.yml


stages:
  - build
  - merge

variables:
  IMAGE_NAME: "registry.qunhequnhe.com/itsystem/open-webui"
  REGISTRY: "registry.qunhequnhe.com"
  PLATFORMS: "linux/amd64,linux/arm64"

.default-build-template: &default-build-template
  tags:
    - kube-runner
  image: docker.1ms.run/library/docker:24.0.2               # 使用官方 docker 镜像（支持docker CLI）
  stage: build
  services:
    - docker.1ms.run/library/docker:dind                   # 启用 Docker-in-Docker 服务，支持构建
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""          # 关闭证书默认环境，简化配置（仅测试环境可行）
  before_script:
    - apk add --no-cache curl jq bash
    - docker info
    # 设置并启动 buildx builder，多平台构建所需
    - |
      if ! docker buildx inspect mybuilder >/dev/null 2>&1; then
        docker buildx create --use --name mybuilder
      else
        docker buildx use mybuilder
      fi
    - docker buildx inspect --bootstrap
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $REGISTRY
  after_script:
    - docker logout $REGISTRY

build-main-image:
  <<: *default-build-template
  script:
    - echo "Building main image for platforms ${PLATFORMS} ..."
    - |
      VERSION=$(jq -r '.version' package.json)
      echo "Read version from package.json: $VERSION"
      docker buildx build \
        --platform ${PLATFORMS} \
        --label "org.opencontainers.image.revision=$CI_COMMIT_SHA" \
        --tag $IMAGE_NAME:latest \
        --tag $IMAGE_NAME:$VERSION \
        --push \
        --cache-from type=registry,ref=$IMAGE_NAME:cache \
        --cache-to type=registry,ref=$IMAGE_NAME:cache,mode=max \
        .
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      when: on_success
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'
      when: on_success

# 你可以类似地把其他 CUDA、OLLAMA 镜像构建定义成不同 job，复用模版并传不同 build arg

build-cuda-image:
  <<: *default-build-template
  script:
    - echo "Building CUDA image for platforms ${PLATFORMS} ..."
    - |
      docker buildx build \
        --platform ${PLATFORMS} \
        --label "org.opencontainers.image.revision=$CI_COMMIT_SHA" \
        --tag $IMAGE_NAME:cuda-latest \
        --tag $IMAGE_NAME:cuda-$CI_COMMIT_REF_NAME \
        --push \
        --cache-from type=registry,ref=$IMAGE_NAME:cuda-cache \
        --cache-to type=registry,ref=$IMAGE_NAME:cuda-cache,mode=max \
        --build-arg USE_CUDA=true \
        .
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      when: on_success
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'
      when: on_success

# 你可以继续添加 build-cuda126-image, build-ollama-image 等 job

# 合并多平台镜像的 manifest（如果有需要）
merge-main-image:
  tags:
    - kube-runner
  image: docker.1ms.run/library/docker:24.0.2
  stage: merge
  services:
    - docker.1ms.run/library/docker:dind
  script:
    - echo "Merging manifests for multi-arch image..."
    - |
      docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $REGISTRY
      docker buildx imagetools create \
        $IMAGE_NAME:latest \
        $IMAGE_NAME:amd64-latest \
        $IMAGE_NAME:arm64-latest
  needs:
    - build-main-image
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# 你也可以写类似 merge-cuda-image，merge-cuda126-image，merge-ollama-image 多平台镜像合并任务
