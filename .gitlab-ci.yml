stages:
  - build-push

variables:
  IMAGE_NAME: "registry.qunhequnhe.com/itsystem/open-webui"
  REGISTRY: "registry.qunhequnhe.com"
  BUILDKIT_HOST: tcp://buildkitd.buildkit-prod.svc.cluster.local:1234
  PROXY_URL: "socks5://10.10.52.137:1088"
  PLATFORMS: "linux/amd64,linux/arm64"

build-push:
  stage: build-push
  image: moby/buildkit:latest
  tags:
    - kube-runner
  variables:
    DOCKER_BUILDKIT: 1
    BUILDKIT_HOST: tcp://buildkitd.buildkit-prod.svc.cluster.local:1234
  script:
    # 调试信息
    - echo "Current directory:$(pwd)"
    - echo "BUILDKIT_HOST:$BUILDKIT_HOST"
    - ls -la
    - head -5 Dockerfile
    
    # 获取版本
    - apk add --no-cache jq
    - VERSION=$(jq -r '.version' package.json)
    - echo "Version:$VERSION"
    
    # 创建认证配置
    - mkdir -p ~/.docker
    - echo "{\"auths\":{\"$REGISTRY\":{\"auth\":\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)\"}}}" > ~/.docker/config.json
    
    # 使用 --addr 参数指定远程buildkit
    - buildctl --addr $BUILDKIT_HOST debug info
    
    # 构建镜像
    - buildctl --addr $BUILDKIT_HOST build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        --opt platform=$PLATFORMS \
        --opt build-arg:HTTP_PROXY=$PROXY_URL \
        --opt build-arg:HTTPS_PROXY=$PROXY_URL \
        --opt build-arg:ALL_PROXY=$PROXY_URL \
        --opt network=host \
        --progress=plain \
        --output type=image,name=$IMAGE_NAME:$CI_COMMIT_SHA,push=true \
        --output type=image,name=$IMAGE_NAME:latest,push=true \
        --output type=image,name=$IMAGE_NAME:$VERSION,push=true
  only:
    - main
    - develop