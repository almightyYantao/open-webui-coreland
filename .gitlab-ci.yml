stages:
  - build-push

variables:
  IMAGE_NAME: "registry.qunhequnhe.com/itsystem/open-webui"
  REGISTRY: "registry.qunhequnhe.com"
  BUILDKIT_HOST: tcp://buildkitd.buildkit-prod.svc.cluster.local:1234
  PROXY_URL: "socks5://10.10.52.137:1088"
  PLATFORMS: "linux/amd64,linux/arm64"

build-push:
  stage: build-push
  image: moby/buildkit:latest
  tags:
    - kube-runner
  variables:
    DOCKER_BUILDKIT: 1
  before_script:
    # 检查文件是否存在
    - ls -la
    - ls -la Dockerfile || echo "Dockerfile not found"
    - ls -la package.json || echo "package.json not found"
    
    # 从package.json获取版本
    - apk add --no-cache jq
    - export VERSION=$(cat package.json | jq -r '.version')
    - echo "Building version $VERSION"
  script:
    # 创建认证配置
    - mkdir -p ~/.docker
    - echo "{\"auths\":{\"$REGISTRY\":{\"auth\":\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)\"}}}" > ~/.docker/config.json
    
    # 验证buildkit连接
    - buildctl debug info
    
    # 使用buildctl构建多平台镜像并推送（修复dockerfile路径）
    - buildctl build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        --opt filename=./Dockerfile \
        --opt platform=$PLATFORMS \
        --opt build-arg:HTTP_PROXY=$PROXY_URL \
        --opt build-arg:HTTPS_PROXY=$PROXY_URL \
        --opt build-arg:ALL_PROXY=$PROXY_URL \
        --opt network=host \
        --progress=plain \
        --output type=image,name=$IMAGE_NAME:$CI_COMMIT_SHA,push=true \
        --output type=image,name=$IMAGE_NAME:latest,push=true \
        --output type=image,name=$IMAGE_NAME:$VERSION,push=true
  only:
    - main
    - develop