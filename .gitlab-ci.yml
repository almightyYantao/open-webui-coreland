stages:
  - build-push

variables:
  IMAGE_NAME: "registry.qunhequnhe.com/itsystem/open-webui"
  REGISTRY: "registry.qunhequnhe.com"
  BUILDKIT_HOST: tcp://buildkitd.buildkit-prod.svc.cluster.local:1234
  PROXY_URL: "socks5://10.10.52.137:1088"
  PLATFORMS: "linux/amd64,linux/arm64"

build-push:
  stage: build-push
  image: docker.1ms.run/library/docker:24-cli
  tags:
    - kube-runner
  before_script:
    # 安装jq获取版本
    - apk add --no-cache jq
    - VERSION=$(jq -r '.version' package.json)
    - echo "Building version:$VERSION"
    
    # 登录私有仓库
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $REGISTRY
  script:
    # 创建使用远程buildkit的构建器
    - docker buildx create --use --name remote-builder --driver remote $BUILDKIT_HOST
    
    # 验证构建器
    - docker buildx ls
    - docker buildx inspect remote-builder --bootstrap
    
    # 多平台构建并推送
    - docker buildx build \
        --platform $PLATFORMS \
        --build-arg HTTP_PROXY=$PROXY_URL \
        --build-arg HTTPS_PROXY=$PROXY_URL \
        --build-arg ALL_PROXY=$PROXY_URL \
        --tag $IMAGE_NAME:$CI_COMMIT_SHA \
        --tag $IMAGE_NAME:latest \
        --tag $IMAGE_NAME:$VERSION \
        --push .
  only:
    - main
    - develop